steps:
  - name: gcr.io/$PROJECT_ID/testrunner
    args:
      - '-c'
      - |
        set -e
        gcloud --version
        make --version
        pip --version
        python --version
        pytest --version
        poetry --version

        poetry install
        make all-tests

        mkdir data
        gsutil cp $_SIC_LOOKUP_CSV data/
        gsutil cp $_SIC_REPHRASE_CSV data/
        ls data
    id: Verify Base Tooling Versions, Run API All Tests and Get Data Files
    entrypoint: bash
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - '-t'
      - $_GAR_IMAGE:$SHORT_SHA
      - .
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - $_GAR_IMAGE:$SHORT_SHA
  - name: gcr.io/$PROJECT_ID/testrunner
    args:
      - '-c'
      - |
        gcloud run deploy survey-assist-api --image=$_GAR_IMAGE:$SHORT_SHA --region $LOCATION --project $_TARGET_PROJECT_ID
        
        export SURVEY_ASSIST_API_URL="https://survey-assist-api-$_TARGET_PROJECT_NUMBER.$LOCATION.run.app/$_API_VERSION/survey-assist"
        export SA_ID_TOKEN=$(gcloud auth print-identity-token --impersonate-service-account=$_API_SA)

        pytest cicd
    id: Deploy Survey Assist API and Run Survey Assist API Smoke Tests
    entrypoint: bash
options:
  logging: CLOUD_LOGGING_ONLY
